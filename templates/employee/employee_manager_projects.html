{% extends "common/layout_base.html" %}

{% block page_title %}Project Matrix | TeamSync Registry{% endblock %}

{% block content %}
<div class="max-w-[1600px] mx-auto px-6 py-8 animate-in fade-in duration-700">

    <header class="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-6 mb-10 pb-8 border-b border-slate-200/60">
        <div class="space-y-1">
            <h1 class="text-6xl font-extrabold text-slate-900 tracking-tight">Project <span class="text-blue-600"> Matrix.</span></h1>

        </div>
        
        <div class="flex items-center gap-3">
            <a href="/manager/manage_teams" class="px-5 py-2.5 bg-white border border-slate-200 text-slate-600 text-xs font-bold rounded-xl hover:bg-slate-50 transition-all shadow-sm flex items-center gap-2">
                <i class="bi bi-arrow-left-short text-lg"></i> Exit to Console
            </a>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
        
        <div class="lg:col-span-4 space-y-6 lg:sticky lg:top-24">
            <div class="bg-white rounded-[2rem] border border-slate-200/70 shadow-sm overflow-hidden flex flex-col h-[calc(100vh-250px)]">
                <div class="p-6 border-b border-slate-100 bg-slate-50/50 space-y-4">
                    <div class="relative group">
                        <i class="bi bi-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="projectSearch" class="w-full bg-white border-slate-200 border pl-11 pr-4 py-3 rounded-2xl text-sm focus:ring-4 focus:ring-blue-50 focus:border-blue-500 outline-none transition-all shadow-sm" placeholder="Search objectives...">
                    </div>
                    <div class="flex gap-2">
                        <button class="flex-1 py-2 text-[10px] font-black uppercase tracking-widest rounded-lg transition-all filter-tab active" onclick="filterProjects('all')">All</button>
                        <button class="flex-1 py-2 text-[10px] font-black uppercase tracking-widest rounded-lg transition-all filter-tab" onclick="filterProjects('active')">Active</button>
                        <button class="flex-1 py-2 text-[10px] font-black uppercase tracking-widest rounded-lg transition-all filter-tab" onclick="filterProjects('completed')">Closed</button>
                    </div>
                </div>
                
                <div class="divide-y divide-slate-50 overflow-y-auto custom-scrollbar" id="projectsList">
                    {% for project in projects %}
                    <div class="p-6 cursor-pointer hover:bg-blue-50/30 transition-all border-l-4 border-transparent project-option project-card group" 
                         data-project-id="{{ project.id }}"
                         data-project-name="{{ project.name }}"
                         data-project-status="{{ project.status }}">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="font-bold text-slate-900 group-hover:text-blue-600 transition-colors">{{ project.name }}</h4>
                            <span class="text-[8px] font-black uppercase px-2 py-0.5 rounded {% if project.status == 'active' %}bg-emerald-50 text-emerald-600{% elif project.status == 'completed' %}bg-slate-100 text-slate-500{% else %}bg-amber-50 text-amber-600{% endif %}">
                                {{ project.status }}
                            </span>
                        </div>
                        <div class="flex items-center gap-4 text-slate-400">
                           <div class="flex items-center gap-1.5">
                               <i class="bi bi-layers text-xs"></i>
                               <span class="text-[10px] font-bold" id="tasks-{{ project.id }}">-</span>
                           </div>
                           <div class="flex items-center gap-1.5">
                               <i class="bi bi-people text-xs"></i>
                               <span class="text-[10px] font-bold" id="employees-{{ project.id }}">-</span>
                           </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-8">
            <div id="noSelectionPanel" class="bg-white rounded-[3rem] border-2 border-dashed border-slate-200 p-24 text-center">
                <div class="w-20 h-20 bg-slate-50 rounded-3xl flex items-center justify-center mx-auto mb-6 text-slate-300">
                    <i class="bi bi-window-stack text-4xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-400 uppercase tracking-widest">No Selection</h3>
                <p class="text-sm text-slate-300 mt-2">Identify a project record from the matrix to initialize the operational view.</p>
            </div>

            <div id="detailPanel" class="hidden space-y-8 animate-in slide-in-from-right-4 duration-500">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-white p-6 rounded-3xl border border-slate-200/60 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Task Volume</p>
                            <p class="text-3xl font-extrabold text-slate-900 mt-1" id="detail-tasks">0</p>
                        </div>
                        <i class="bi bi-kanban text-2xl text-blue-100"></i>
                    </div>
                    <div class="bg-white p-6 rounded-3xl border border-slate-200/60 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Personnel</p>
                            <p class="text-3xl font-extrabold text-slate-900 mt-1" id="detail-employees">0</p>
                        </div>
                        <i class="bi bi-person-check text-2xl text-blue-100"></i>
                    </div>
                    <div class="bg-white p-6 rounded-3xl border border-slate-200/60 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Lifecycle Stage</p>
                            <p class="text-xl font-black text-blue-600 mt-2 uppercase tracking-tighter" id="detail-status">--</p>
                        </div>
                        <i class="bi bi-diagram-3 text-2xl text-blue-100"></i>
                    </div>
                </div>

                <div class="bg-white rounded-[2.5rem] border border-slate-200/60 shadow-sm overflow-hidden">
                    <div class="px-8 py-4 bg-slate-50/50 border-b border-slate-100 flex justify-between items-center">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Operational Scope & Briefing</span>
                        <span id="detail-created" class="text-[9px] font-bold text-slate-400 uppercase"></span>
                    </div>
                    <div class="p-8 space-y-6">
                        <p id="detail-description" class="text-lg font-medium text-slate-700 leading-relaxed"></p>
                        
                        <form id="projectDescriptionForm" class="bg-slate-50 p-6 rounded-2xl border border-slate-100 space-y-4">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Update Operational Dossier</label>
                            <textarea id="projectDescriptionInput" rows="3" class="w-full px-5 py-4 bg-white border border-slate-200 rounded-xl text-sm font-medium outline-none focus:ring-4 focus:ring-blue-50 focus:border-blue-500 transition-all resize-none" placeholder="Provide strategic context..."></textarea>
                            <div class="flex items-center justify-between">
                                <span id="projectDescriptionStatus" class="text-[9px] font-bold text-blue-500 uppercase"></span>
                                <button type="submit" class="px-6 py-2.5 bg-slate-900 text-white text-xs font-bold rounded-lg hover:bg-blue-600 transition-all">Save Directive</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <div class="bg-white rounded-[2rem] border border-slate-200/60 shadow-sm flex flex-col">
                        <div class="px-6 py-4 border-b border-slate-50 font-black text-[10px] text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <i class="bi bi-people-fill text-blue-500"></i> Deployment Roster
                        </div>
                        <div class="p-6 space-y-6">
                            <form id="projectAssignForm" class="space-y-4">
                                <div class="relative">
                                    <select id="projectAssignEmployee" class="w-full bg-slate-50 border border-slate-200 px-5 py-3 rounded-xl text-xs font-bold text-slate-700 uppercase outline-none focus:ring-4 focus:ring-blue-50 focus:border-blue-500 appearance-none transition-all cursor-pointer">
                                        <option value="">Identify Personnel...</option>
                                        {% for emp in employees %}
                                          <option value="{{ emp.employee_id }}">{{ emp.name }} [{{ emp.employee_id }}]</option>
                                        {% endfor %}
                                    </select>
                                    <i class="bi bi-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span id="projectAssignStatus" class="text-[9px] font-bold text-blue-500 uppercase"></span>
                                    <button type="submit" class="px-5 py-2.5 bg-white border border-slate-200 text-slate-700 text-xs font-bold rounded-lg hover:bg-slate-50 transition-all shadow-sm">Confirm Deployment</button>
                                </div>
                            </form>
                            <div class="flex flex-wrap gap-2 pt-4" id="detail-employees-list"></div>
                        </div>
                    </div>

                    <div class="bg-white rounded-[2rem] border border-slate-200/60 shadow-sm flex flex-col">
                        <div class="px-6 py-4 border-b border-slate-50 font-black text-[10px] text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <i class="bi bi-journal-check text-blue-500"></i> Deployment Log
                        </div>
                        <div class="p-6 space-y-6">
                            <form id="projectTaskForm" class="space-y-3 bg-slate-50 p-4 rounded-xl border border-slate-100">
                                <input type="text" id="projectTaskTitle" class="w-full bg-white border border-slate-200 px-4 py-2.5 rounded-lg text-xs font-bold outline-none focus:border-blue-500" placeholder="Objective Title" required>
                                <textarea id="projectTaskDescription" rows="2" class="w-full bg-white border border-slate-200 px-4 py-2 rounded-lg text-xs font-medium outline-none" placeholder="Description"></textarea>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="date" id="projectTaskDeadline" class="bg-white border border-slate-200 px-3 py-2 rounded-lg text-[10px] font-bold">
                                    <div class="relative">
                                        <select id="projectTaskAssignee" class="w-full bg-white border border-slate-200 px-3 py-2 rounded-lg text-[10px] font-bold appearance-none">
                                            <option value="">Lead (Optional)</option>
                                            {% for emp in employees %}
                                              <option value="{{ emp.employee_id }}">{{ emp.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <i class="bi bi-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-300"></i>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between pt-2">
                                    <span id="projectTaskStatus" class="text-[9px] font-bold text-blue-500 uppercase"></span>
                                    <button type="submit" class="px-5 py-2 bg-blue-600 text-white text-[10px] font-black uppercase tracking-widest rounded-lg hover:bg-blue-700 transition-all">Append Task</button>
                                </div>
                            </form>
                            <div id="detail-tasks-list" class="space-y-3 max-h-60 overflow-y-auto custom-scrollbar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Refined Scrollbar */
.custom-scrollbar::-webkit-scrollbar { width: 4px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

/* Filter Tabs */
.filter-tab { background: transparent; color: #94a3b8; border: 1px solid transparent; }
.filter-tab.active { background: #0f172a; color: white; border-color: #0f172a; }

/* Active Project Styling */
.project-card.active { 
    background: #f8fafc; 
    border-left-color: #4f46e5 !important;
    box-shadow: inset 0 0 10px rgba(79, 70, 229, 0.05);
}

.employee-tag {
    background: #f1f5f9;
    color: #475569;
    border: 1px solid #e2e8f0;
}
</style>



<script>
let allProjects = [];
let selectedProjectId = null;

function getTodayIsoDate() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

document.addEventListener('DOMContentLoaded', function() {
  // Set up project card click/touch handlers
  document.querySelectorAll('.project-option').forEach(card => {
    const selectHandler = function() {
      selectProject(parseInt(this.getAttribute('data-project-id')));
    };
    card.addEventListener('click', selectHandler);
    card.addEventListener('touchstart', selectHandler, { passive: true });
    card.addEventListener('pointerdown', selectHandler);
  });

  // Prevent delete clicks from selecting the card
  document.querySelectorAll('.project-remove-form').forEach(form => {
    form.addEventListener('click', function(event) {
      event.stopPropagation();
    });
    form.addEventListener('touchstart', function(event) {
      event.stopPropagation();
    });
  });
  
  // Fetch all projects data
  fetch('/api/all_projects')
    .then(res => res.json())
    .then(data => {
      allProjects = data;
      populateProjectData();
    })
    .catch(err => console.error('Error fetching projects:', err));

  const descriptionForm = document.getElementById('projectDescriptionForm');
  const descriptionInput = document.getElementById('projectDescriptionInput');
  const descriptionStatus = document.getElementById('projectDescriptionStatus');
  if (descriptionForm) {
    descriptionForm.addEventListener('submit', function(event) {
      event.preventDefault();
      if (!selectedProjectId) return;
      const fd = new FormData();
      fd.append('project_id', String(selectedProjectId));
      fd.append('description', descriptionInput.value || '');
      descriptionStatus.textContent = 'Saving...';
      fetch('/manager/projects/update_description', { method: 'POST', body: fd })
        .then(res => res.json())
        .then(data => {
          if (data && data.ok) {
            const project = allProjects.find(p => p.id === selectedProjectId);
            if (project) project.description = data.description || '';
            document.getElementById('detail-description').textContent = data.description || 'No description provided';
            descriptionStatus.textContent = 'Saved';
          } else {
            descriptionStatus.textContent = 'Failed';
          }
          setTimeout(() => { descriptionStatus.textContent = ''; }, 2000);
        })
        .catch(() => {
          descriptionStatus.textContent = 'Failed';
          setTimeout(() => { descriptionStatus.textContent = ''; }, 2000);
        });
    });
  }

  const taskForm = document.getElementById('projectTaskForm');
  const taskTitle = document.getElementById('projectTaskTitle');
  const taskDescription = document.getElementById('projectTaskDescription');
  const taskDeadline = document.getElementById('projectTaskDeadline');
  const taskStatus = document.getElementById('projectTaskStatus');
  if (taskDeadline) {
    taskDeadline.setAttribute('min', getTodayIsoDate());
  }
  if (taskForm) {
    taskForm.addEventListener('submit', function(event) {
      event.preventDefault();
      if (!selectedProjectId) return;
      if (!taskTitle.value.trim()) return;
      const fd = new FormData();
      fd.append('project_id', String(selectedProjectId));
      fd.append('title', taskTitle.value.trim());
      fd.append('description', taskDescription.value || '');
      if (taskDeadline.value && taskDeadline.value < getTodayIsoDate()) {
        taskStatus.textContent = 'Past date not allowed';
        setTimeout(() => { taskStatus.textContent = ''; }, 2000);
        return;
      }
      if (taskDeadline.value) fd.append('deadline', taskDeadline.value);
      const assigneeSelect = document.getElementById('projectTaskAssignee');
      if (assigneeSelect && assigneeSelect.value) {
        fd.append('assignee_employee_id', assigneeSelect.value);
      }
      taskStatus.textContent = 'Adding...';
      fetch('/manager/projects/add_task', { method: 'POST', body: fd })
        .then(res => res.json())
        .then(data => {
          if (data && data.ok) {
            const project = allProjects.find(p => p.id === selectedProjectId);
            if (project) {
              project.tasks = project.tasks || [];
              project.tasks.unshift(data.task);
              project.task_count = (project.task_count || 0) + 1;
            }
            taskTitle.value = '';
            taskDescription.value = '';
            taskDeadline.value = '';
            renderTaskList(project);
            if (project) {
              const detailTasks = document.getElementById('detail-tasks');
              if (detailTasks) detailTasks.textContent = project.task_count;
            }
            populateProjectData();
            taskStatus.textContent = 'Added';
          } else {
            taskStatus.textContent = 'Failed';
          }
          setTimeout(() => { taskStatus.textContent = ''; }, 2000);
        })
        .catch(() => {
          taskStatus.textContent = 'Failed';
          setTimeout(() => { taskStatus.textContent = ''; }, 2000);
        });
    });
  }

  const assignForm = document.getElementById('projectAssignForm');
  const assignSelect = document.getElementById('projectAssignEmployee');
  const assignStatus = document.getElementById('projectAssignStatus');
  if (assignForm) {
    assignForm.addEventListener('submit', function(event) {
      event.preventDefault();
      if (!selectedProjectId) return;
      if (!assignSelect.value) return;
      const fd = new FormData();
      fd.append('project_id', String(selectedProjectId));
      fd.append('employee_id', assignSelect.value);
      assignStatus.textContent = 'Assigning...';
      fetch('/manager/projects/assign_employee', { method: 'POST', body: fd })
        .then(res => res.json())
        .then(data => {
          const project = allProjects.find(p => p.id === selectedProjectId);
          if (data && data.ok && project) {
            project.assigned_employees = data.assigned_employees || project.assigned_employees || [];
            project.direct_assignments = data.direct_assignments || project.direct_assignments || [];
            project.employee_count = data.employee_count;
            renderAssignedEmployees(project);
            const detailEmployees = document.getElementById('detail-employees');
            if (detailEmployees) detailEmployees.textContent = project.employee_count;
            populateProjectData();
            assignStatus.textContent = 'Assigned';
          } else {
            assignStatus.textContent = (data && data.message) ? data.message : 'Failed';
          }
          setTimeout(() => { assignStatus.textContent = ''; }, 2000);
        })
        .catch(() => {
          assignStatus.textContent = 'Failed';
          setTimeout(() => { assignStatus.textContent = ''; }, 2000);
        });
    });
  }

  const employeeList = document.getElementById('detail-employees-list');
  if (employeeList) {
    employeeList.addEventListener('click', function(event) {
      const btn = event.target.closest('[data-unassign-id]');
      if (!btn || !selectedProjectId) return;
      const employeeId = btn.getAttribute('data-unassign-id');
      if (!employeeId) return;
      const fd = new FormData();
      fd.append('project_id', String(selectedProjectId));
      fd.append('employee_id', employeeId);
      fetch('/manager/projects/unassign_employee', { method: 'POST', body: fd })
        .then(res => res.json())
        .then(data => {
          const project = allProjects.find(p => p.id === selectedProjectId);
          if (data && data.ok && project) {
            project.assigned_employees = data.assigned_employees || project.assigned_employees || [];
            project.direct_assignments = data.direct_assignments || project.direct_assignments || [];
            project.employee_count = data.employee_count;
            renderAssignedEmployees(project);
            const detailEmployees = document.getElementById('detail-employees');
            if (detailEmployees) detailEmployees.textContent = project.employee_count;
            populateProjectData();
          }
        })
        .catch(() => {});
    });
  }
  
  // Search functionality
  document.getElementById('projectSearch').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    document.querySelectorAll('.project-option').forEach(card => {
      const name = card.getAttribute('data-project-name').toLowerCase();
      card.style.display = name.includes(query) ? 'flex' : 'none';
    });
  });
});

function populateProjectData() {
  allProjects.forEach(project => {
    const cardTasks = document.getElementById('tasks-' + project.id);
    const cardEmps = document.getElementById('employees-' + project.id);
    const projEmps = document.getElementById('proj-emps-' + project.id);
    
    if (cardTasks) cardTasks.textContent = project.task_count;
    if (cardEmps) cardEmps.textContent = project.employee_count;
    
    if (projEmps && project.assigned_employees.length > 0) {
      projEmps.innerHTML = project.assigned_employees.slice(0, 3).map(emp => 
        '<div class="employee-tag">' + emp + '</div>'
      ).join('');
      if (project.assigned_employees.length > 3) {
        projEmps.innerHTML += '<div class="employee-tag">+' + (project.assigned_employees.length - 3) + ' more</div>';
      }
    }
  });
}

function selectProject(projectId) {
  selectedProjectId = projectId;
  
  // Update active card
  document.querySelectorAll('.project-card').forEach(card => {
    card.classList.remove('active');
  });
  document.querySelector('[data-project-id="' + projectId + '"]').classList.add('active');
  
  // Show detail panel
  document.getElementById('detailPanel').classList.remove('hidden');
  document.getElementById('noSelectionPanel').classList.add('hidden');
  
  // Find project data
  const project = allProjects.find(p => p.id === projectId);
  if (!project) return;
  
  // Populate detail panel
  document.getElementById('detail-tasks').textContent = project.task_count;
  document.getElementById('detail-employees').textContent = project.employee_count;
  document.getElementById('detail-status').textContent = project.status.toUpperCase().charAt(0) + project.status.slice(1);
  document.getElementById('detail-description').textContent = project.description || 'No description provided';
  const descriptionInput = document.getElementById('projectDescriptionInput');
  if (descriptionInput) {
    descriptionInput.value = project.description || '';
  }
  
  const createdDate = new Date(project.created_at);
  document.getElementById('detail-created').textContent = 
    'Created on ' + createdDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  
  // Populate employees
  renderAssignedEmployees(project);
  
  renderTaskList(project);
}

function renderAssignedEmployees(project) {
  const empList = document.getElementById('detail-employees-list');
  if (!empList || !project) return;
  const employees = Array.isArray(project.assigned_employees) ? project.assigned_employees : [];
  const directAssignments = Array.isArray(project.direct_assignments) ? project.direct_assignments : [];
  const directNames = new Set(directAssignments.map(item => item.name));

  if (employees.length === 0 && directAssignments.length === 0) {
    empList.innerHTML = '<p class="text-sm text-slate-500">No employees assigned to this project</p>';
    return;
  }

  const directTags = directAssignments.map(item => {
    return (
      '<div class="employee-tag flex items-center gap-2">' +
        '<span>' + item.name + '</span>' +
        '<button type="button" class="text-slate-400 hover:text-red-600" data-unassign-id="' + item.employee_id + '">x</button>' +
      '</div>'
    );
  });

  const otherTags = employees
    .filter(name => !directNames.has(name))
    .map(name => '<div class="employee-tag">' + name + '</div>');

  empList.innerHTML = directTags.concat(otherTags).join('');
}

function renderTaskList(project) {
  const taskList = document.getElementById('detail-tasks-list');
  if (!taskList || !project) return;
  const tasks = Array.isArray(project.tasks) ? project.tasks : [];
  if (tasks.length === 0) {
    taskList.innerHTML = '<p class="text-sm text-slate-500">No tasks in this project</p>';
    return;
  }
  taskList.innerHTML = tasks.map(task => {
    const deadline = task.deadline ? new Date(task.deadline).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'No deadline';
    return `
      <div class="border border-slate-200 rounded-lg p-4 mb-3">
        <div class="flex items-center justify-between">
          <div class="font-bold text-slate-900">${task.title}</div>
          <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">${task.status}</span>
        </div>
        <div class="text-xs text-slate-600 mt-2">${task.description || ''}</div>
        <div class="text-[10px] text-slate-400 mt-2">Deadline: ${deadline}</div>
      </div>
    `;
  }).join('');
}

function filterProjects(status) {
  // Update active tab
  document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // Filter projects
  document.querySelectorAll('.project-option').forEach(card => {
    const cardStatus = card.getAttribute('data-project-status');
    if (status === 'all' || cardStatus === status) {
      card.style.display = 'flex';
    } else {
      card.style.display = 'none';
    }
  });
}
</script>
{% endblock %}
