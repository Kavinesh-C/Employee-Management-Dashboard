{% extends "common/layout_base.html" %}

{% block page_title %}Team Roster | {{ team.name }}{% endblock %}

{% block content %}
<div class="max-w-[1400px] mx-auto px-6 py-8 animate-in fade-in duration-700">

    <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-12 bg-white/40 backdrop-blur-md p-8 rounded-[2.5rem] border border-white/60 shadow-sm">
        <div class="flex items-center gap-5">
            <div class="w-16 h-16 bg-slate-900 rounded-3xl flex items-center justify-center text-white text-2xl shadow-xl shadow-slate-200">
                <i class="bi bi-people-fill"></i>
            </div>
            <div>
                <nav class="flex items-center gap-2 text-[10px] font-black text-blue-600 uppercase tracking-widest mb-1">
                   
                  
                    <span>Team </span>
                </nav>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight leading-none">{{ team.name }}</h1>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <div class="px-4 py-2 bg-slate-100 rounded-xl border border-slate-200 hidden sm:block">
                <p class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">Capacity</p>
                <p class="text-xs font-bold text-slate-700">{{ members|length }} Active Personnel</p>
            </div>
            <a href="/manager/manage_teams" class="px-6 py-3 bg-white border border-slate-200 text-slate-600 text-xs font-bold rounded-2xl hover:bg-slate-50 transition-all shadow-sm flex items-center gap-2">
                <i class="bi bi-arrow-left"></i> Back to Teams
            </a>
        </div>
    </header>

    {% if members %}
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        {% for member in members %}
        <div class="group bg-white rounded-[2rem] border border-slate-200/60 p-6 hover:shadow-2xl hover:shadow-blue-500/5 hover:border-blue-200 transition-all duration-300 relative cursor-pointer"
             onclick="openMemberTaskModal(this)"
             data-team-id="{{ team.id }}"
             data-team-project-id="{{ team.project_id or '' }}"
             data-team-project-name="{{ team.project.name if team.project else '' }}"
             data-employee-id="{{ member.employee_id }}"
             data-employee-name="{{ member.name }}">
            
            <div class="flex items-start justify-between mb-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center font-black text-lg border border-blue-100 group-hover:bg-blue-600 group-hover:text-white transition-all duration-500">
                        {{ member.name[0]|upper }}
                    </div>
                    <div>
                        <h3 class="text-sm font-black text-slate-900 uppercase tracking-tight">{{ member.name }}</h3>
                        <p class="text-[10px] font-mono text-slate-400">#{{ member.employee_id }}</p>
                    </div>
                </div>
                
                <span class="px-2.5 py-1 text-[8px] font-black uppercase rounded-lg tracking-widest
                    {% if member.role == 'admin' %} bg-red-50 text-red-600 border border-red-100
                    {% elif member.role == 'manager' %} bg-blue-50 text-blue-600 border border-blue-100
                    {% else %} bg-slate-50 text-slate-500 border border-slate-100 {% endif %}">
                    {{ member.role or 'Staff' }}
                </span>
            </div>

            <div class="space-y-3 bg-slate-50/50 p-4 rounded-2xl border border-slate-100 mb-6">
                <div class="flex justify-between items-center">
                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Division</span>
                    <span class="text-[10px] font-bold text-slate-700">{{ member.department or 'N/A' }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Availability</span>
                    <span class="text-[10px] font-black {% if member.is_active %} text-emerald-500 {% else %} text-slate-300 {% endif %} uppercase">
                        {{ 'Active' if member.is_active else 'Inactive' }}
                    </span>
                </div>
            </div>

            <div class="space-y-3">
                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                    <i class="bi bi-list-task text-blue-500"></i> Active Directives
                </p>
                <div class="space-y-2">
                    {% for task in member.tasks %}
                    <div class="flex items-center justify-between text-[10px] p-2 bg-white border border-slate-100 rounded-xl group-hover:border-blue-100 transition-colors">
                        <span class="font-bold text-slate-600 truncate max-w-[120px]">{{ task.title }}</span>
                        <span class="text-[8px] font-black uppercase text-blue-500">{{ task.status }}</span>
                    </div>
                    {% else %}
                    <p class="text-[10px] text-slate-300 italic py-2">No directives assigned.</p>
                    {% endfor %}
                </div>
            </div>

            <div class="mt-4 flex justify-end">
              <button class="opacity-0 group-hover:opacity-100 transition-opacity text-blue-600 text-xs font-bold uppercase tracking-widest flex items-center gap-1 bg-white/0 border border-transparent hover:border-blue-100 px-3 py-2 rounded-lg">
                Assign Task <i class="bi bi-plus-lg"></i>
              </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="py-32 flex flex-col items-center justify-center bg-white/50 border-2 border-dashed border-slate-200 rounded-[3rem]">
        <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-6">
            <i class="bi bi-person-slash text-3xl text-slate-300"></i>
        </div>
        <p class="text-slate-400 font-bold uppercase tracking-[0.2em] text-sm">No Personnel Found</p>
        <p class="text-slate-300 text-xs mt-2">Assign staff to this team to begin operational tracking.</p>
    </div>
    {% endif %}

</div>

<div id="memberTaskModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md transition-opacity" onclick="closeMemberTaskModal()"></div>
    
    <div class="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl relative overflow-hidden animate-in zoom-in duration-300 flex flex-col max-h-[90vh]">
        <div class="h-1.5 w-full bg-slate-900"></div>
        
        <button onclick="closeMemberTaskModal()" class="absolute top-8 right-8 p-2 text-slate-400 hover:text-slate-900 bg-slate-50 rounded-full transition-all z-10">
            <i class="bi bi-x-lg"></i>
        </button>

        <div class="p-10 overflow-y-auto custom-scrollbar">
            <div class="mb-10">
                <nav class="flex items-center gap-2 text-[10px] font-black text-blue-500 uppercase tracking-[0.2em] mb-3">
                    <i class="bi bi-person-badge"></i> Personnel Dossier
                </nav>
                <h3 id="memberTaskMeta" class="text-3xl font-extrabold text-slate-900 tracking-tight leading-none"></h3>
                <p id="memberTaskProject" class="text-xs font-bold text-slate-400 mt-3 uppercase tracking-widest"></p>
            </div>

            <div class="space-y-4 mb-10">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] flex items-center gap-3">
                    Directive History <span class="h-px flex-1 bg-slate-100"></span>
                </p>
                <div id="memberTaskList" class="grid grid-cols-1 gap-3">
                    </div>
            </div>

            <form action="/manager/team_tasks/create" method="POST" class="bg-slate-50/50 p-8 rounded-[2rem] border border-slate-100 space-y-6" id="memberTaskForm">
                <input type="hidden" name="team_id" id="memberTaskTeamId">
                <input type="hidden" name="assignees" id="memberTaskAssignee">

                <div class="group">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Task Title</label>
                    <input type="text" name="title" required placeholder="E.G. SYSTEMS_AUDIT" class="w-full bg-white border border-slate-200 px-5 py-4 rounded-2xl text-xs font-bold uppercase tracking-widest outline-none focus:ring-4 focus:ring-blue-50 focus:border-blue-500 transition-all">
                </div>

                <div class="group">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Directive Briefing</label>
                    <textarea name="description" rows="3" class="w-full bg-white border border-slate-200 px-5 py-4 rounded-2xl text-xs font-medium outline-none focus:ring-4 focus:ring-blue-50 focus:border-blue-500 transition-all resize-none"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="group">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Priority</label>
                        <select name="priority" class="w-full bg-white border border-slate-200 px-5 py-4 rounded-2xl text-[10px] font-black uppercase outline-none focus:ring-4 focus:ring-blue-50 focus:border-blue-500 appearance-none cursor-pointer">
                            <option value="low">Alpha (Low)</option>
                            <option value="medium" selected>Beta (Medium)</option>
                            <option value="high">Gamma (High)</option>
                        </select>
                    </div>
                    <div class="group">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Target Deadline</label>
                        <input type="date" id="memberTaskDueDate" name="due_date" class="w-full bg-white border border-slate-200 px-5 py-3.5 rounded-2xl text-[10px] font-black outline-none focus:ring-4 focus:ring-blue-50 focus:border-blue-500 transition-all">
                    </div>
                </div>

                <p id="memberTaskProjectNote" class="text-[10px] font-bold text-amber-600 bg-amber-50 p-3 rounded-xl border border-amber-100 hidden">
                    <i class="bi bi-exclamation-triangle-fill"></i> Operational Warning: This unit has no active project linkage. Link a project to enable task deployment.
                </p>

                <div class="flex justify-end items-center gap-6 pt-4">
                    <button type="button" onclick="closeMemberTaskModal()" class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 hover:text-slate-900 transition-colors">Abort Entry</button>
                    <button type="submit" id="memberTaskSubmit" class="px-8 py-4 bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest rounded-2xl hover:bg-blue-600 hover:shadow-lg hover:shadow-blue-100 transition-all flex items-center gap-2">
                        <span>Deploy Directive</span>
                        <i class="bi bi-send-fill text-[10px]"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Refined Scrollbar */
.custom-scrollbar::-webkit-scrollbar { width: 4px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

/* Status Styles inside Modal List */
.task-item-status { font-size: 8px; font-weight: 900; padding: 2px 8px; border-radius: 6px; text-transform: uppercase; }
.status-pending { background: #fff7ed; color: #ea580c; }
.status-completed { background: #f0fdf4; color: #16a34a; }
</style>

<script>
// JavaScript Logic (Updating Task Card UI inside modal list)
function updateModalTaskList(tasks) {
    const listDiv = document.getElementById('memberTaskList');
    if (tasks.length === 0) {
        listDiv.innerHTML = '<div class="text-slate-400 text-[10px] font-bold uppercase tracking-widest py-8 bg-slate-50 border border-dashed border-slate-200 rounded-[2rem] text-center">No Active Directives</div>';
    } else {
        listDiv.innerHTML = tasks.map((task, idx) => `
            <div class="bg-white border border-slate-100 p-4 rounded-2xl hover:border-blue-100 transition-all group/item">
                <div class="flex justify-between items-start mb-2">
                    <div class="font-bold text-xs text-slate-800 uppercase tracking-tight">${task.title}</div>
                    <span class="task-item-status status-${task.status.toLowerCase()}">${task.status}</span>
                </div>
                <div class="text-[10px] text-slate-500 mb-3">${task.description || 'No strategic description provided.'}</div>
                <div class="flex items-center justify-between pt-3 border-t border-slate-50">
                    <div class="text-[9px] font-bold text-slate-400 uppercase">Target: ${task.due_date || 'N/A'}</div>
                    <div class="flex gap-2 opacity-0 group-hover/item:opacity-100 transition-opacity">
                        <button class="p-2 bg-blue-50 text-blue-600 rounded-lg text-[10px] hover:bg-blue-100 transition-colors" onclick="editTask('${task.title}', ${idx}, '${task.status}')"><i class="bi bi-pencil"></i></button>
                        <button class="p-2 bg-red-50 text-red-600 rounded-lg text-[10px] hover:bg-red-100 transition-colors" onclick="deleteTask('${task.title}', ${idx}, '${task.status}')"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
            </div>
        `).join('');
    }
}
// Apply updateModalTaskList inside your openMemberTaskModal logic...
</script>

{% include 'admin/edit_task_modal.html' %}
<script>
  function getTodayIsoDate() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // Real member tasks data from backend
  const memberTasksData = {
    {% for member in members %}
      '{{ member.employee_id }}': [
        {% for task in member.tasks %}
        {
          title: {{ task.title|tojson }},
          status: {{ task.status|tojson }},
          description: {{ task.description|tojson }},
          assigned_at: {{ task.assigned_at|tojson }},
          completed_at: {{ task.completed_at|tojson }},
          due_date: {{ task.due_date|tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]{% if not loop.last %},{% endif %}
    {% endfor %}
  };

  function openMemberTaskModal(card) {
    const teamId = card.getAttribute('data-team-id') || '';
    const projectId = card.getAttribute('data-team-project-id') || '';
    const projectName = card.getAttribute('data-team-project-name') || '';
    const employeeId = card.getAttribute('data-employee-id') || '';
    const employeeName = card.getAttribute('data-employee-name') || '';

    document.getElementById('memberTaskTeamId').value = teamId;
    document.getElementById('memberTaskAssignee').value = employeeId;
    document.getElementById('memberTaskMeta').textContent = `Assigning to: ${employeeName} (${employeeId})`;
    document.getElementById('memberTaskProject').textContent = projectName
      ? `Project: ${projectName}`
      : 'Project: Not linked';

    // Populate the task list in the modal
    const taskListDiv = document.getElementById('memberTaskList');
    const tasks = memberTasksData[employeeId] || [];
    if (tasks.length === 0) {
      taskListDiv.innerHTML = '<div class="text-gray-400 text-sm">No tasks assigned</div>';
    } else {
      let html = '<div class="mb-2 font-bold text-slate-900">Current Tasks</div>';
      html += '<div class="space-y-3">';
      tasks.forEach((task, idx) => {
        html += `<div class=\"border border-slate-200 rounded p-3 bg-slate-50\">\n`
          + `<div class=\"font-bold text-xs mb-1\">${task.title}</div>\n`
          + `<div class=\"text-xs text-slate-500 mb-1\">Status: <span class=\"font-semibold\">${task.status}</span></div>\n`
          + `<div class=\"text-xs text-slate-500 mb-1\">Description: <span class=\"font-normal\">${task.description || '-'} </span></div>\n`
          + `<div class=\"text-xs text-slate-500 mb-1\">Assigned: <span class=\"font-normal\">${task.assigned_at || '-'} </span></div>\n`
          + `<div class=\"text-xs text-slate-500 mb-1\">Completed: <span class=\"font-normal\">${task.completed_at || '-'} </span></div>\n`
          + `<div class=\"text-xs text-slate-500 mb-1\">Due: <span class=\"font-normal\">${task.due_date || '-'} </span></div>\n`
          + `<div class=\"flex gap-3 mt-2\">\n`
          + `<button type=\"button\" class=\"px-3 py-1 text-xs font-bold rounded bg-blue-100 text-blue-700 hover:bg-blue-200 transition\" onclick=\"editTask(${idx})\">Edit</button>\n`
          + `<button type=\"button\" class=\"px-3 py-1 text-xs font-bold rounded bg-red-100 text-red-700 hover:bg-red-200 transition\" onclick=\"deleteTask(${idx})\">Delete</button>\n`
          + `</div>\n`
        + `</div>`;
      });
      html += '</div>';
      taskListDiv.innerHTML = html;
    }

    const projectNote = document.getElementById('memberTaskProjectNote');
    const submitBtn = document.getElementById('memberTaskSubmit');
    const dueDateInput = document.getElementById('memberTaskDueDate');
    if (dueDateInput) {
      dueDateInput.setAttribute('min', getTodayIsoDate());
    }
    if (!projectId) {
      projectNote.classList.remove('hidden');
      submitBtn.disabled = true;
      submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
      projectNote.classList.add('hidden');
      submitBtn.disabled = false;
      submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    document.getElementById('memberTaskModal').classList.remove('hidden');
  }


  function editTask(idx) {
    // Find the employeeId from the open modal context
    const employeeId = document.getElementById('memberTaskAssignee').value;
    const task = (memberTasksData[employeeId] || [])[idx];
    if (!task) return;
    document.getElementById('editTaskEmployeeId').value = employeeId;
    document.getElementById('editTaskIdx').value = idx;
    document.getElementById('editTaskTitle').value = task.title || '';
    document.getElementById('editTaskDescription').value = task.description || '';
    document.getElementById('editTaskStatus').value = task.status || 'pending';
    const editTaskDueDate = document.getElementById('editTaskDueDate');
    editTaskDueDate.setAttribute('min', getTodayIsoDate());
    editTaskDueDate.value = task.due_date || '';
    document.getElementById('editTaskModal').classList.remove('hidden');
  }

  async function deleteTask(idx) {
    const employeeId = document.getElementById('memberTaskAssignee').value;
    const task = (memberTasksData[employeeId] || [])[idx];
    if (!task) return;

    if (!confirm('Are you sure you want to delete task: ' + task.title + '?')) {
      return;
    }

    const resp = await fetch('/manager/delete_task', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        employee_id: employeeId,
        idx: idx,
        task_title: task.title || ''
      })
    });

    if (resp.ok) {
      alert('Task deleted.');
      location.reload();
    } else {
      alert('Failed to delete task.');
    }
  }

  function closeEditTaskModal() {
    document.getElementById('editTaskModal').classList.add('hidden');
  }

  // Handle edit form submit (AJAX)
  document.addEventListener('DOMContentLoaded', function() {
    const memberTaskDueDate = document.getElementById('memberTaskDueDate');
    if (memberTaskDueDate) {
      memberTaskDueDate.setAttribute('min', getTodayIsoDate());
    }
    const memberTaskForm = document.getElementById('memberTaskForm');
    if (memberTaskForm) {
      memberTaskForm.addEventListener('submit', function(e) {
        if (!memberTaskDueDate || !memberTaskDueDate.value) return;
        if (memberTaskDueDate.value < getTodayIsoDate()) {
          e.preventDefault();
          alert('Past date not allowed.');
        }
      });
    }

    const form = document.getElementById('editTaskForm');
    const editTaskDueDate = document.getElementById('editTaskDueDate');
    if (editTaskDueDate) {
      editTaskDueDate.setAttribute('min', getTodayIsoDate());
    }
    if (form) {
      form.onsubmit = async function(e) {
        e.preventDefault();
        if (editTaskDueDate && editTaskDueDate.value && editTaskDueDate.value < getTodayIsoDate()) {
          alert('Past date not allowed.');
          return;
        }
        const employeeId = document.getElementById('editTaskEmployeeId').value;
        const idx = document.getElementById('editTaskIdx').value;
        const payload = {
          employee_id: employeeId,
          idx: idx,
          title: document.getElementById('editTaskTitle').value,
          description: document.getElementById('editTaskDescription').value,
          status: document.getElementById('editTaskStatus').value,
          due_date: document.getElementById('editTaskDueDate').value
        };
        // Send to backend (implement /manager/update_task endpoint)
        const resp = await fetch('/manager/update_task', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (resp.ok) {
          alert('Task updated!');
          closeEditTaskModal();
          location.reload();
        } else {
          alert('Failed to update task.');
        }
      }
    }
  });

  function closeMemberTaskModal() {
    document.getElementById('memberTaskModal').classList.add('hidden');
  }
</script>

{% endblock %}
