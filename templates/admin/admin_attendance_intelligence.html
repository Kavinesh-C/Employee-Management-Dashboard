{% extends "common/layout_base.html" %}
{% block page_title %}Attendance Intelligence{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-8 space-y-10">

  <!-- HEADER -->
  <div>
    <h1 class="text-3xl font-black text-slate-900">Attendance Intelligence</h1>
    <p class="text-sm text-slate-500 mt-1">
      Organizational attendance performance & behavioral insights
    </p>
  </div>

  <!-- KPI STRIP -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
    {% set kpis = [
      ("Avg Login", metrics.average_login_hour|int ~ ":00"),
      ("Avg Work Hrs", metrics.average_work_hours),
      ("Score", metrics.attendance_score ~ "/100"),
      ("Risk", metrics.risk_level|upper)
    ] %}
    {% for label, value in kpis %}
    <div class="bg-white border rounded-lg p-6">
      <p class="text-xs uppercase text-slate-400">{{ label }}</p>
      <p class="text-2xl font-black">{{ value }}</p>
    </div>
    {% endfor %}
  </div>

  <!-- LEADERBOARD -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

    <div class="bg-white border rounded-lg p-6">
      <h2 class="text-sm font-black uppercase tracking-widest text-green-600 mb-4">
        Top Performers
      </h2>
      {% for emp in top_performers %}
        <div class="flex justify-between py-2 border-b last:border-0">
          <span class="font-medium">{{ emp.name }}</span>
          <span class="font-black text-green-600">{{ emp.score }}</span>
        </div>
      {% else %}
        <p class="text-sm text-slate-400">No strong performers yet</p>
      {% endfor %}
    </div>

    <div class="bg-white border rounded-lg p-6">
      <h2 class="text-sm font-black uppercase tracking-widest text-red-600 mb-4">
        At-Risk Employees
      </h2>
      {% for emp in low_performers %}
        <div class="flex justify-between py-2 border-b last:border-0">
          <span class="font-medium">{{ emp.name }}</span>
          <span class="font-black text-red-600">{{ emp.score }}</span>
        </div>
      {% else %}
        <p class="text-sm text-slate-400">No critical cases detected</p>
      {% endfor %}
    </div>

  </div>

  <!-- COMPARISON CHART -->
  <div class="bg-white border rounded-lg p-6">
    <h2 class="text-sm font-black uppercase tracking-widest mb-4">
      Attendance Score Comparison
    </h2>
    <div class="h-[280px]">
      <canvas id="performanceChart"></canvas>
    </div>
  </div>

  <!-- ALERTS -->
  <div>
    <h2 class="text-sm font-black uppercase tracking-widest mb-4">
      Alerts
    </h2>
    {% for a in anomalies %}
      <div class="border-l-4 border-orange-500 bg-orange-50 p-4 mb-3">
        <p class="font-medium">{{ a.reason }}</p>
        <p class="text-xs text-slate-500">{{ a.employee_id }} â€¢ {{ a.date }}</p>
      </div>
    {% else %}
      <p class="text-sm text-slate-400">No anomalies detected</p>
    {% endfor %}
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
new Chart(document.getElementById("performanceChart"), {
  type: "bar",
  data: {
    labels: {{ (top_performers + low_performers)|map(attribute='name')|list|tojson }},
    datasets: [{
      data: {{ (top_performers + low_performers)|map(attribute='score')|list|tojson }},
      backgroundColor: "#2563eb",
      borderRadius: 4
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: { y: { beginAtZero: true, max: 100 } }
  }
});
</script>
{% endblock %}
